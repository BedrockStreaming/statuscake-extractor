# ---- Base ----
FROM node:10.16-stretch-slim AS base

WORKDIR /srv/deploy

RUN groupadd --system --gid 2001 m6group \
  && useradd --system --uid 1001 --group m6group m6user

RUN apt-get update && \
  apt-get install -y git && \
  apt-get clean

ARG CUSTOMER
ENV CUSTOMER=$CUSTOMER

ARG SOURCES_DIR
COPY --chown=root:root $SOURCES_DIR/.yarnrc $SOURCES_DIR/package.json $SOURCES_DIR/yarn.lock $SOURCES_DIR/lerna.json /srv/deploy/
COPY --chown=root:root $SOURCES_DIR/packages /srv/deploy/packages

# ---- Prod ----
FROM base AS prod

RUN yarn install --frozen-lockfile --non-interactive --no-progress && yarn cache clean
COPY --chown=root:root $SOURCES_DIR /srv/deploy
RUN yarn build

USER m6user:m6group
CMD ["yarn start"]

ARG VCS_TYPE=git
ARG VCS_URL
ARG VCS_REF
ARG BUILD_DATE
LABEL build-date=$BUILD_DATE \
  vcs-type=$VCS_TYPE \
  vcs-url=$VCS_URL \
  vcs-ref=$VCS_REF
